worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Store tokens here for Lua script to use
    lua_shared_dict tokens 10m;

    # DNS resolver for container networking
    resolver 127.0.0.11;

    server {
        listen 8080;

        # Allow all websites to access this (CORS setup)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

        location / {
            # Run Lua script to check auth before sending request to backend
            access_by_lua_file /etc/nginx/lua/auth.lua;

            # Forward request to backend Python service
            proxy_pass http://python-service:1723;
        }
    }
}
